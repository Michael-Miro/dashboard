<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>驻 ' - 拽 3</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #2C97D1 0%, #1A5F85 100%);
            color: white;
            padding: 15px 40px;
            box-shadow: 0 4px 15px rgba(44, 151, 209, 0.2);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            height: 60px;
            width: auto;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            gap: 10px;
            padding: 20px 40px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab-button {
            padding: 12px 30px;
            border: none;
            background: #e8eef5;
            color: #1e3a5f;
            font-size: 16px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background: #d0dbe8;
        }

        .tab-button.active {
            background: #2C97D1;
            color: white;
        }

        .container {
            padding: 30px 40px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .add-button {
            padding: 12px 25px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .add-button:hover {
            background: #218838;
        }

        .search-box {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            width: 250px;
        }

        .data-table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .data-table th,
        .data-table td {
            padding: 15px 20px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2C97D1;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-available {
            background: #d4edda;
            color: #155724;
        }

        .status-in-use {
            background: #fff3cd;
            color: #856404;
        }

        .status-maintenance {
            background: #f8d7da;
            color: #721c24;
        }

        .status-graded {
            background: #e2e3e5;
            color: #383d41;
        }

        .status-on-base {
            background: #d4edda;
            color: #155724;
        }

        .status-sick {
            background: #f8d7da;
            color: #721c24;
        }

        .status-refresher {
            background: #fff3cd;
            color: #856404;
        }

        .status-working {
            background: #cce5ff;
            color: #004085;
        }

        .work-fields {
            display: none;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .work-fields.active {
            display: block;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-edit,
        .btn-delete {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: opacity 0.3s;
        }

        .btn-edit {
            background: #007bff;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-edit:hover,
        .btn-delete:hover {
            opacity: 0.8;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: #1e3a5f;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #1e3a5f;
        }

        .submit-button {
            width: 100%;
            padding: 14px;
            background: #1e3a5f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .submit-button:hover {
            background: #2d5a87;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            flex: 1;
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: 700;
            color: #1e3a5f;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
            }

            .header h1 {
                font-size: 20px;
            }

            .tabs {
                padding: 15px 20px;
                gap: 8px;
            }

            .tab-button {
                padding: 10px 20px;
                font-size: 14px;
                flex: 1;
                text-align: center;
            }

            .container {
                padding: 15px;
            }

            .stats-bar {
                flex-wrap: wrap;
                gap: 10px;
            }

            .stat-card {
                flex: 1 1 30%;
                /* Fit 3 per row */
                min-width: 90px;
                padding: 10px;
            }

            .stat-card h3 {
                font-size: 11px;
                margin-bottom: 4px;
            }

            .stat-card .number {
                font-size: 20px;
            }

            .actions-bar {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .actions-bar>div {
                flex-direction: column !important;
                gap: 10px !important;
            }

            .actions-bar select,
            .actions-bar input {
                width: 100% !important;
                font-size: 16px !important;
            }

            .add-button {
                width: 100%;
                text-align: center;
            }

            .search-box {
                width: 100% !important;
                font-size: 16px !important;
            }

            /* Prevent zoom on focus */
            input,
            select,
            textarea {
                font-size: 16px !important;
            }

            /* Table becomes compact list on mobile */
            .data-table {
                display: block;
            }

            .data-table thead {
                display: none;
            }

            .data-table tbody {
                display: block;
            }

            .data-table tr {
                display: flex;
                flex-wrap: wrap;
                /* Allow wrapping for details */
                align-items: center;
                background: white;
                padding: 8px 12px;
                border-bottom: 1px solid #eee;
                justify-content: space-between;
                /* Spread items across width */
                gap: 8px;
            }

            .data-table tr:first-child {
                border-radius: 8px 8px 0 0;
            }

            .data-table tr:last-child {
                border-radius: 0 0 8px 8px;
                border-bottom: none;
            }

            /* Base state for all cells - hidden but ready for expansion */
            .data-table td {
                display: flex;
                max-height: 0;
                overflow: hidden;
                padding: 0;
                margin: 0;
                opacity: 0;
                width: 100%;
                order: 10;
                justify-content: space-between;
                gap: 15px;
                align-items: center;
                border: none;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            /* Always visible columns */
            .data-table td:first-child {
                display: block;
                max-height: none;
                opacity: 1;
                width: auto;
                order: 1;
                padding: 0;
                font-weight: 600;
                color: #1e3a5f;
                min-width: 60px;
            }

            .data-table td:nth-child(4) {
                display: block;
                max-height: none;
                opacity: 1;
                width: auto;
                order: 2;
                margin-right: 0;
                /* Removed auto margin that was pushing it to the far side */
                padding: 0;
            }

            .data-table td:last-child {
                display: flex;
                max-height: none;
                opacity: 1;
                width: auto;
                order: 3;
                margin-right: 0;
                padding: 0;
                gap: 5px;
            }

            /* Labels for expanded content */
            .data-table td::before {
                content: attr(data-label);
                display: inline-block;
                font-weight: 600;
                color: #666;
                font-size: 0.9em;
            }

            /* Hide labels for always-visible columns */
            .data-table td:first-child::before,
            .data-table td:nth-child(4):::before,
            .data-table td:last-child::before {
                display: none;
            }

            /* Expanded State styling */
            .data-table tr.expanded {
                background-color: #f8f9fa;
            }

            .data-table tr.expanded td {
                max-height: 50px;
                /* Adjust based on content */
                opacity: 1;
                padding: 8px 10px;
                /* Add padding only when expanded */
                border-top: 1px solid #f0f0f0;
                margin-top: 2px;
            }

            /* Ensure always-visible cells don't get expanded styling */
            .data-table tr.expanded td:first-child,
            .data-table tr.expanded td:nth-child(4),
            .data-table tr.expanded td:last-child {
                max-height: none;
                padding: 0;
                border: none;
                margin: 0;
            }

            .status-badge {
                font-size: 11px;
                padding: 3px 8px;
            }

            .action-buttons {
                gap: 5px;
            }

            .btn-edit,
            .btn-delete {
                padding: 5px 10px;
                font-size: 12px;
                text-align: center;
                padding: 6px 8px;
                font-size: 11px;
            }

            .modal-content {
                padding: 20px;
                margin: 10px;
                max-height: 85vh;
            }

            .form-group input,
            .form-group select {
                font-size: 16px;
                padding: 14px;
            }

            .sync-buttons {
                display: none;
            }

            /* Search Mode - Hide clutter when searching */
            body.search-mode .header,
            body.search-mode .tabs,
            body.search-mode .stats-bar,
            body.search-mode .add-button {
                display: none !important;
            }

            body.search-mode .container {
                padding-top: 10px;
            }

            body.search-mode .actions-bar {
                margin-bottom: 10px;
                position: sticky;
                top: 0;
                z-index: 100;
                background: #f5f7fa;
                padding-bottom: 10px;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <img src="./logo.png" alt="Logo" class="logo">
            <h1>驻 ' - 拽 3</h1>
        </div>
    </header>

    <nav class="tabs">
        <button class="tab-button" data-tab="cars"> 专</button>
        <button class="tab-button active" data-tab="people"> </button>
    </nav>

    <main class="container">
        <!-- Cars Tab -->
        <div id="cars" class="tab-content">
            <div class="stats-bar">
                <div class="stat-card">
                    <h3>住" 专</h3>
                    <div class="number" id="total-cars">0</div>
                </div>
                <div class="stat-card">
                    <h3></h3>
                    <div class="number" id="available-cars">0</div>
                </div>
                <div class="stat-card">
                    <h3>砖砖</h3>
                    <div class="number" id="inuse-cars">0</div>
                </div>
                <div class="stat-card">
                    <h3>转拽</h3>
                    <div class="number" id="maintenance-cars">0</div>
                </div>
                <div class="stat-card">
                    <h3>专</h3>
                    <div class="number" id="graded-cars">0</div>
                </div>
            </div>

            <div class="actions-bar">
                <button class="add-button" onclick="openModal('car')">+ 住祝 专</button>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <select id="filter-car-type" class="search-box" style="width: 120px;" onchange="filterCars()">
                        <option value=""> 住</option>
                        <option value="freight">驻专</option>
                        <option value="inter">专</option>
                    </select>
                    <select id="filter-car-cargo" class="search-box" style="width: 120px;" onchange="filterCars()">
                        <option value=""> 砖转</option>
                        <option value="cover">住</option>
                        <option value="mustang">住</option>
                    </select>
                    <select id="filter-car-status" class="search-box" style="width: 120px;" onchange="filterCars()">
                        <option value=""> 住住</option>
                        <option value="available"></option>
                        <option value="in-use">砖砖</option>
                        <option value="maintenance">转拽</option>
                        <option value="graded">专</option>
                    </select>
                    <input type="text" class="search-box" placeholder="驻砖 专..." id="search-cars"
                        oninput="filterCars()">
                </div>
            </div>

            <table class="data-table" id="cars-table">
                <thead>
                    <tr>
                        <th>爪'</th>
                        <th>住</th>
                        <th>砖</th>
                        <th>住住</th>
                        <th> 砖</th>
                        <th>转专 驻 </th>
                        <th>驻注转</th>
                    </tr>
                </thead>
                <tbody id="cars-body">
                </tbody>
            </table>
        </div>

        <!-- People Tab -->
        <div id="people" class="tab-content active">
            <div class="stats-bar">
                <div class="stat-card">
                    <h3>住" </h3>
                    <div class="number" id="total-people">0</div>
                </div>
                <div class="stat-card">
                    <h3>住住</h3>
                    <div class="number" id="people-on-base">0</div>
                </div>
                <div class="stat-card">
                    <h3></h3>
                    <div class="number" id="people-sick">0</div>
                </div>
                <div class="stat-card">
                    <h3>专注</h3>
                    <div class="number" id="people-refresher">0</div>
                </div>
                <div class="stat-card">
                    <h3>注</h3>
                    <div class="number" id="people-working">0</div>
                </div>
            </div>

            <div class="actions-bar">
                <button class="add-button" onclick="openModal('person')">+ 住祝 </button>
                <input type="text" class="search-box" placeholder="驻砖 ..." id="search-people"
                    oninput="filterTable('people')">
            </div>

            <table class="data-table" id="people-table">
                <thead>
                    <tr>
                        <th>砖 </th>
                        <th>住驻专 砖</th>
                        <th>驻</th>
                        <th>住住</th>
                        <th> / 住住</th>
                        <th>住驻专 住转</th>
                        <th>住 住转</th>
                        <th>驻注转</th>
                    </tr>
                </thead>
                <tbody id="people-body">
                </tbody>
            </table>
        </div>
    </main>

    <!-- Car Modal -->
    <div class="modal" id="car-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="car-modal-title">住祝 专 砖</h2>
                <button class="close-button" onclick="closeModal('car')">&times;</button>
            </div>
            <form id="car-form" onsubmit="saveCar(event)">
                <input type="hidden" id="car-id">
                <div class="form-group">
                    <label>爪'</label>
                    <input type="text" id="car-number" required placeholder="住驻专 爪'">
                </div>
                <div class="form-group">
                    <label>住</label>
                    <select id="car-type" required>
                        <option value="freight">驻专</option>
                        <option value="inter">专</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>砖</label>
                    <select id="car-cargo" required>
                        <option value="cover">住</option>
                        <option value="mustang">住</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>住住</label>
                    <select id="car-status" required>
                        <option value="available"></option>
                        <option value="in-use">砖砖</option>
                        <option value="maintenance">转拽</option>
                        <option value="graded">专</option>
                    </select>
                </div>
                <div class="form-group">
                    <label> 砖</label>
                    <select id="car-driver">
                        <option value="">  砖</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>转专 驻 </label>
                    <input type="date" id="car-next-service">
                </div>
                <button type="submit" class="submit-button">砖专</button>
            </form>
        </div>
    </div>

    <!-- Person Modal -->
    <div class="modal" id="person-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="person-modal-title">住祝  砖</h2>
                <button class="close-button" onclick="closeModal('person')">&times;</button>
            </div>
            <form id="person-form" onsubmit="savePerson(event)">
                <input type="hidden" id="person-id">
                <div class="form-group">
                    <label>砖 </label>
                    <input type="text" id="person-name" required placeholder="砖 驻专 砖驻">
                </div>
                <div class="form-group">
                    <label>住驻专 砖</label>
                    <input type="text" id="person-id-number" required placeholder="住驻专 砖">
                </div>
                <div class="form-group">
                    <label>驻</label>
                    <input type="tel" id="person-phone" required placeholder="050-1234567">
                </div>
                <div class="form-group">
                    <label>住住</label>
                    <select id="person-status" required onchange="toggleWorkFields()">
                        <option value="on-base">住住</option>
                        <option value="sick"></option>
                        <option value="refresher">专注</option>
                        <option value="working">注</option>
                    </select>
                </div>
                <div class="work-fields" id="work-fields">
                    <div class="form-group">
                        <label> / 住住</label>
                        <input type="text" id="person-unit" placeholder="砖   住住">
                    </div>
                    <div class="form-group">
                        <label>住驻专 住转</label>
                        <input type="text" id="person-reference" placeholder="住驻专 住转">
                    </div>
                    <div class="form-group">
                        <label>住 住转</label>
                        <input type="date" id="person-reference-end">
                    </div>
                </div>
                <button type="submit" class="submit-button">砖专</button>
            </form>
        </div>
    </div>

    <script>
        // Initial People Data from images
        const initialPeopleData = [
            { id: '1', name: '\' ', idNumber: '8850469', phone: '050-4869544', status: 'on-base' },
            { id: '2', name: '住 ', idNumber: '7420936', phone: '054-2230393', status: 'on-base' },
            { id: '3', name: '爪拽 ', idNumber: '7538447', phone: '052-5304625', status: 'on-base' },
            { id: '4', name: '驻专住  注', idNumber: '8633863', phone: '052-4788790', status: 'on-base' },
            { id: '5', name: ' 转', idNumber: '6626000', phone: '054-3068404', status: 'on-base' },
            { id: '6', name: '砖专 拽住', idNumber: '8224223', phone: '050-3997699', status: 'on-base' },
            { id: '7', name: '专 ', idNumber: '8381378', phone: '053-8212543', status: 'on-base' },
            { id: '8', name: '专 专', idNumber: '7026184', phone: '052-6749258', status: 'on-base' },
            { id: '9', name: '注专  专', idNumber: '5953869', phone: '053-2226165', status: 'on-base' },
            { id: '10', name: '  专砖', idNumber: '5873319', phone: '054-3179788', status: 'on-base' },
            { id: '11', name: '转 \'注', idNumber: '8287754', phone: '050-5795940', status: 'on-base' },
            { id: '12', name: '专 ', idNumber: '8454874', phone: '054-3423236', status: 'on-base' },
            { id: '13', name: ' 住拽', idNumber: '5825866', phone: '054-8341551', status: 'on-base' },
            { id: '14', name: '注 专住 专', idNumber: '6191025', phone: '052-5211961', status: 'on-base' },
            { id: '15', name: ' 砖', idNumber: '8452744', phone: '053-5307635', status: 'on-base' },
            { id: '16', name: ' ', idNumber: '5789051', phone: '054-4746867', status: 'on-base' },
            { id: '17', name: '转 爪\' 驻住', idNumber: '5822901', phone: '054-7366937', status: 'on-base' },
            { id: '18', name: '住 驻住', idNumber: '8510000', phone: '052-5148683', status: 'on-base' },
            { id: '19', name: '专 拽', idNumber: '8589461', phone: '052-5496067', status: 'on-base' },
            { id: '20', name: ' 住', idNumber: '8478415', phone: '052-6242089', status: 'on-base' },
            { id: '21', name: '砖 ', idNumber: '5490326', phone: '054-2388342', status: 'on-base' },
            { id: '22', name: '驻住 ', idNumber: '6119213', phone: '054-4338572', status: 'on-base' },
            { id: '23', name: ' ', idNumber: '7433843', phone: '050-7319266', status: 'on-base' },
            { id: '24', name: ' 拽', idNumber: '7161108', phone: '052-7011676', status: 'on-base' },
            { id: '25', name: ' 专', idNumber: '5242481', phone: '052-4661656', status: 'on-base' },
            { id: '26', name: '专 ', idNumber: '7452451', phone: '054-4559549', status: 'on-base' },
            { id: '27', name: ' 专', idNumber: '5387463', phone: '054-7797132', status: 'on-base' },
            { id: '28', name: '转 专住', idNumber: '8152591', phone: '050-5775089', status: 'on-base' },
            { id: '29', name: '专 ', idNumber: '8138496', phone: '054-3470879', status: 'on-base' },
            { id: '30', name: '专 住专', idNumber: '8451296', phone: '053-5322705', status: 'on-base' },
            { id: '31', name: '专 注', idNumber: '7575896', phone: '052-5900421', status: 'on-base' },
            { id: '32', name: '注 注', idNumber: '8394144', phone: '054-8743204', status: 'on-base' },
            { id: '33', name: '住 拽专', idNumber: '8382861', phone: '052-4100692', status: 'on-base' },
            { id: '34', name: '专 专', idNumber: '5490050', phone: '052-9597715', status: 'on-base' },
            { id: '35', name: '注 专', idNumber: '9682604', phone: '052-8018176', status: 'on-base' }
        ];

        // Data Storage
        let cars = JSON.parse(localStorage.getItem('fleet_cars')) || [];
        let people = JSON.parse(localStorage.getItem('fleet_people')) || [];

        // Load initial data only if empty or if data version changed
        const DATA_VERSION = '2';
        if (people.length === 0 || localStorage.getItem('fleet_data_version') !== DATA_VERSION) {
            people = initialPeopleData;
            localStorage.setItem('fleet_people', JSON.stringify(people));
            localStorage.setItem('fleet_data_version', DATA_VERSION);
        }

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDlHH-T44B7-9KGteM2Fo2mO7Q1j_vOn88",
            authDomain: "fleet-dashboard-e1c72.firebaseapp.com",
            databaseURL: "https://fleet-dashboard-e1c72-default-rtdb.firebaseio.com",
            projectId: "fleet-dashboard-e1c72",
            storageBucket: "fleet-dashboard-e1c72.firebasestorage.app",
            messagingSenderId: "48562204954",
            appId: "1:48562204954:web:4fad6b0c94874f4ea73ca3"
        };

        // Initialize Firebase
        let firebaseEnabled = false;
        let database = null;

        function initFirebase() {
            try {
                if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    firebaseEnabled = true;
                    setupFirebaseListeners();
                    updateSyncStatus('专', 'green');
                    console.log('Firebase initialized successfully');
                } else {
                    updateSyncStatus(' 专', 'orange');
                    console.log('Firebase not configured - using localStorage only');
                }
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateSyncStatus('砖', 'red');
            }
        }

        function updateSyncStatus(text, color) {
            const statusEl = document.getElementById('sync-status');
            if (statusEl) {
                statusEl.textContent = text;
                statusEl.style.background = color;
            }
        }

        function setupFirebaseListeners() {
            // Listen for cars changes
            database.ref('cars').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    cars = Object.values(data);
                    localStorage.setItem('fleet_cars', JSON.stringify(cars));
                    renderCars();
                    updateStats();
                }
            });

            // Listen for people changes
            database.ref('people').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    people = Object.values(data);
                    localStorage.setItem('fleet_people', JSON.stringify(people));
                    renderPeople();
                    updateStats();
                }
            });
        }

        function syncToFirebase(collection, data) {
            if (!firebaseEnabled) return;

            const dataObject = {};
            data.forEach(item => {
                dataObject[item.id] = item;
            });

            database.ref(collection).set(dataObject)
                .then(() => console.log(`${collection} synced to Firebase`))
                .catch(error => console.error(`Firebase sync error:`, error));
        }

        function syncAllData() {
            if (!firebaseEnabled) {
                alert('Firebase  专. 拽 转 专 专.');
                return;
            }

            syncToFirebase('cars', cars);
            syncToFirebase('people', people);
            alert(' 转 住专 爪!');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            initFirebase();
            renderCars();
            renderPeople();
            updateStats();
            setupTabs();
            setupSearchListeners();
        });

        // Check if we are on the mobile view
        function isMobile() {
            return window.innerWidth <= 768;
        }

        // Mobile Search Mode Logic
        function setupSearchListeners() {
            const searchInputs = [document.getElementById('search-cars'), document.getElementById('search-people')];

            searchInputs.forEach(input => {
                if (!input) return;

                input.addEventListener('focus', () => {
                    if (isMobile()) {
                        document.body.classList.add('search-mode');
                    }
                });

                input.addEventListener('blur', () => {
                    // Small delay to allow clicking results without jumping layout immediately
                    setTimeout(() => {
                        document.body.classList.remove('search-mode');
                    }, 200);
                });
            });
        }

        // Tab Navigation
        function setupTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(button.dataset.tab).classList.add('active');
                });
            });
        }

        // Modal Functions
        function openModal(type) {
            if (type === 'car') {
                document.getElementById('car-modal-title').textContent = '住祝 专 砖';
                document.getElementById('car-form').reset();
                document.getElementById('car-id').value = '';
                updateDriverDropdown();
            } else {
                document.getElementById('person-modal-title').textContent = '住祝  砖';
                document.getElementById('person-form').reset();
                document.getElementById('person-id').value = '';
                document.getElementById('work-fields').classList.remove('active');
            }
            document.getElementById(type + '-modal').classList.add('active');
        }

        function closeModal(type) {
            document.getElementById(type + '-modal').classList.remove('active');
        }

        // Update driver dropdown in car form (only show people on base)
        function updateDriverDropdown() {
            const driverSelect = document.getElementById('car-driver');
            driverSelect.innerHTML = '<option value="">  砖</option>';
            people.filter(person => person.status === 'on-base').forEach(driver => {
                driverSelect.innerHTML += `<option value="${driver.id}">${driver.name}</option>`;
            });
        }

        // Car Functions
        function saveCar(event) {
            event.preventDefault();

            const carId = document.getElementById('car-id').value;
            const carData = {
                id: carId || Date.now().toString(),
                number: document.getElementById('car-number').value,
                type: document.getElementById('car-type').value,
                cargo: document.getElementById('car-cargo').value,
                status: document.getElementById('car-status').value,
                driverId: document.getElementById('car-driver').value,
                nextService: document.getElementById('car-next-service').value || ''
            };

            if (carId) {
                const index = cars.findIndex(car => car.id === carId);
                if (index !== -1) {
                    cars[index] = carData;
                }
            } else {
                cars.push(carData);
            }

            localStorage.setItem('fleet_cars', JSON.stringify(cars));
            syncToFirebase('cars', cars);
            closeModal('car');
            renderCars();
            updateStats();
        }

        function editCar(carId) {
            const car = cars.find(c => c.id === carId);
            if (car) {
                document.getElementById('car-modal-title').textContent = '注专转 专';
                document.getElementById('car-id').value = car.id;
                document.getElementById('car-number').value = car.number;
                document.getElementById('car-type').value = car.type || 'freight';
                document.getElementById('car-cargo').value = car.cargo || 'cover';
                document.getElementById('car-status').value = car.status;
                updateDriverDropdown();
                document.getElementById('car-driver').value = car.driverId || '';
                document.getElementById('car-next-service').value = car.nextService || '';
                document.getElementById('car-modal').classList.add('active');
            }
        }

        function deleteCar(carId) {
            if (confirm(' 转  砖专爪 拽 专 ?')) {
                cars = cars.filter(car => car.id !== carId);
                localStorage.setItem('fleet_cars', JSON.stringify(cars));
                syncToFirebase('cars', cars);
                renderCars();
                updateStats();
            }
        }

        function renderCars() {
            const tbody = document.getElementById('cars-body');

            if (cars.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <h3> 专 注专转</h3>
                                <p>抓 注 "住祝 专"  转</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            const typeNames = {
                'freight': '驻专',
                'inter': '专'
            };

            const cargoNames = {
                'cover': '住',
                'mustang': '住'
            };

            const statusClasses = {
                'available': 'status-available',
                'in-use': 'status-in-use',
                'maintenance': 'status-maintenance',
                'graded': 'status-graded'
            };

            const statusNames = {
                'available': '',
                'in-use': '砖砖',
                'maintenance': '转拽',
                'graded': '专'
            };

            tbody.innerHTML = cars.map(car => {
                const driver = people.find(p => p.id === car.driverId);
                const carType = car.type || 'freight';
                const carCargo = car.cargo || 'cover';

                return `
                    <tr onclick="toggleDetails(this)" style="cursor: pointer">
                        <td data-label="爪'">${car.number}</td>
                        <td data-label="住">${typeNames[carType]}</td>
                        <td data-label="砖">${cargoNames[carCargo]}</td>
                        <td data-label="住住"><span class="status-badge ${statusClasses[car.status]}">${statusNames[car.status]}</span></td>
                        <td data-label=" 砖">${driver ? driver.name : '-'}</td>
                        <td data-label="驻 ">${car.nextService || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-edit" onclick="event.stopPropagation(); editCar('${car.id}')">注专</button>
                                <button class="btn-delete" onclick="event.stopPropagation(); deleteCar('${car.id}')">拽</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Toggle work fields visibility
        function toggleWorkFields() {
            const status = document.getElementById('person-status').value;
            const workFields = document.getElementById('work-fields');
            if (status === 'working') {
                workFields.classList.add('active');
            } else {
                workFields.classList.remove('active');
            }
        }

        // Person Functions
        function savePerson(event) {
            event.preventDefault();

            const personId = document.getElementById('person-id').value;
            const status = document.getElementById('person-status').value;
            const personData = {
                id: personId || Date.now().toString(),
                name: document.getElementById('person-name').value,
                idNumber: document.getElementById('person-id-number').value,
                phone: document.getElementById('person-phone').value,
                status: status,
                unit: status === 'working' ? document.getElementById('person-unit').value || '' : '',
                reference: status === 'working' ? document.getElementById('person-reference').value || '' : '',
                referenceEnd: status === 'working' ? document.getElementById('person-reference-end').value || '' : ''
            };

            if (personId) {
                const index = people.findIndex(person => person.id === personId);
                if (index !== -1) {
                    people[index] = personData;
                }
            } else {
                people.push(personData);
            }

            localStorage.setItem('fleet_people', JSON.stringify(people));
            syncToFirebase('people', people);
            closeModal('person');
            renderPeople();
            updateStats();
        }

        function editPerson(personId) {
            const person = people.find(p => p.id === personId);
            if (person) {
                document.getElementById('person-modal-title').textContent = '注专转 ';
                document.getElementById('person-id').value = person.id;
                document.getElementById('person-name').value = person.name;
                document.getElementById('person-id-number').value = person.idNumber;
                document.getElementById('person-phone').value = person.phone;
                document.getElementById('person-status').value = person.status || 'on-base';
                document.getElementById('person-unit').value = person.unit || '';
                document.getElementById('person-reference').value = person.reference || '';
                document.getElementById('person-reference-end').value = person.referenceEnd || '';
                toggleWorkFields();
                document.getElementById('person-modal').classList.add('active');
            }
        }

        function deletePerson(personId) {
            if (confirm(' 转  砖专爪 拽  ?')) {
                // Remove driver association from cars
                cars.forEach(car => {
                    if (car.driverId === personId) {
                        car.driverId = '';
                    }
                });
                localStorage.setItem('fleet_cars', JSON.stringify(cars));
                syncToFirebase('cars', cars);

                people = people.filter(person => person.id !== personId);
                localStorage.setItem('fleet_people', JSON.stringify(people));
                syncToFirebase('people', people);
                renderPeople();
                renderCars();
                updateStats();
            }
        }

        function renderPeople() {
            const tbody = document.getElementById('people-body');

            if (people.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <h3>  注专转</h3>
                                <p>抓 注 "住祝 "  转</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            const statusNames = {
                'on-base': '住住',
                'sick': '',
                'refresher': '专注',
                'working': '注'
            };

            const statusClasses = {
                'on-base': 'status-on-base',
                'sick': 'status-sick',
                'refresher': 'status-refresher',
                'working': 'status-working'
            };

            tbody.innerHTML = people.map(person => {
                const personStatus = person.status || 'on-base';
                return `
                <tr onclick="toggleDetails(this)" style="cursor: pointer">
                    <td data-label=""><strong>${person.name}</strong></td>
                    <td data-label="住驻专 砖">${person.idNumber}</td>
                    <td data-label="驻">${person.phone}</td>
                    <td data-label="住住"><span class="status-badge ${statusClasses[personStatus]}">${statusNames[personStatus]}</span></td>
                    <td data-label=" / 住住">${person.unit || '-'}</td>
                    <td data-label="住驻专 住转">${person.reference || '-'}</td>
                    <td data-label="住 住转">${person.referenceEnd || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" onclick="event.stopPropagation(); editPerson('${person.id}')">注专</button>
                            <button class="btn-delete" onclick="event.stopPropagation(); deletePerson('${person.id}')">拽</button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        // Statistics
        function updateStats() {
            document.getElementById('total-cars').textContent = cars.length;
            document.getElementById('available-cars').textContent = cars.filter(c => c.status === 'available').length;
            document.getElementById('inuse-cars').textContent = cars.filter(c => c.status === 'in-use').length;
            document.getElementById('maintenance-cars').textContent = cars.filter(c => c.status === 'maintenance').length;
            document.getElementById('graded-cars').textContent = cars.filter(c => c.status === 'graded').length;

            document.getElementById('total-people').textContent = people.length;
            document.getElementById('people-on-base').textContent = people.filter(p => p.status === 'on-base' || !p.status).length;
            document.getElementById('people-sick').textContent = people.filter(p => p.status === 'sick').length;
            document.getElementById('people-refresher').textContent = people.filter(p => p.status === 'refresher').length;
            document.getElementById('people-working').textContent = people.filter(p => p.status === 'working').length;
        }

        // Search/Filter
        function filterTable(type) {
            const searchValue = document.getElementById('search-' + type).value.toLowerCase();
            const tbody = document.getElementById(type + '-body');
            const rows = tbody.querySelectorAll('tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchValue) ? '' : 'none';
            });
        }

        // Filter cars by type, cargo, status, and search
        function filterCars() {
            const typeFilter = document.getElementById('filter-car-type').value;
            const cargoFilter = document.getElementById('filter-car-cargo').value;
            const statusFilter = document.getElementById('filter-car-status').value;
            const searchValue = document.getElementById('search-cars').value.toLowerCase();
            const tbody = document.getElementById('cars-body');

            const typeNames = {
                'freight': '驻专',
                'inter': '专'
            };

            const cargoNames = {
                'cover': '住',
                'mustang': '住'
            };

            const statusClasses = {
                'available': 'status-available',
                'in-use': 'status-in-use',
                'maintenance': 'status-maintenance',
                'graded': 'status-graded'
            };

            const statusNames = {
                'available': '',
                'in-use': '砖砖',
                'maintenance': '转拽',
                'graded': '专'
            };

            const filteredCars = cars.filter(car => {
                const matchesType = !typeFilter || car.type === typeFilter;
                const carCargo = car.cargo || 'cover';
                const matchesCargo = !cargoFilter || carCargo === cargoFilter;
                const matchesStatus = !statusFilter || car.status === statusFilter;
                const carType = car.type || 'freight';
                const driver = people.find(p => p.id === car.driverId);
                const searchText = `${car.number} ${typeNames[carType]} ${cargoNames[carCargo]} ${statusNames[car.status]} ${driver ? driver.name : ''} ${car.nextService || ''}`.toLowerCase();
                const matchesSearch = !searchValue || searchText.includes(searchValue);
                return matchesType && matchesCargo && matchesStatus && matchesSearch;
            });

            if (filteredCars.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <h3> 爪 专</h3>
                                <p>住 砖转 转 住</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredCars.map(car => {
                const driver = people.find(p => p.id === car.driverId);
                const carType = car.type || 'freight';
                const carCargo = car.cargo || 'cover';

                return `
                    <tr onclick="toggleDetails(this)" style="cursor: pointer">
                        <td data-label="爪'">${car.number}</td>
                        <td data-label="住">${typeNames[carType]}</td>
                        <td data-label="砖">${cargoNames[carCargo]}</td>
                        <td data-label="住住"><span class="status-badge ${statusClasses[car.status]}">${statusNames[car.status]}</span></td>
                        <td data-label=" 砖">${driver ? driver.name : '-'}</td>
                        <td data-label="驻 ">${car.nextService || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-edit" onclick="event.stopPropagation(); editCar('${car.id}')">注专</button>
                                <button class="btn-delete" onclick="event.stopPropagation(); deleteCar('${car.id}')">拽</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Export data to JSON file
        function exportData() {
            const exportData = {
                version: DATA_VERSION,
                exportDate: new Date().toISOString(),
                cars: cars,
                people: people
            };

            const dataString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = `dashboard-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            URL.revokeObjectURL(url);

            alert('转 爪 爪!');
        }

        // Import data from JSON file
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (!importedData.cars || !importedData.people) {
                        throw new Error('拽抓  转拽');
                    }

                    if (confirm(`  ${importedData.cars.length} 专 -${importedData.people.length} 砖?\n驻注  转祝 转  转 拽.`)) {
                        cars = importedData.cars;
                        people = importedData.people;

                        localStorage.setItem('fleet_cars', JSON.stringify(cars));
                        localStorage.setItem('fleet_people', JSON.stringify(people));
                        localStorage.setItem('fleet_data_version', importedData.version || DATA_VERSION);

                        renderCars();
                        renderPeople();
                        updateStats();

                        alert('转  爪!');
                    }
                } catch (error) {
                    alert('砖  拽抓.   砖拽抓 转拽.');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Toggle row details
        function toggleDetails(row) {
            // Only toggle on mobile (check window width or simply always toggle class, class only affects mobile via CSS media query)
            row.classList.toggle('expanded');
        }

        // Close modal when clicking outside
        window.addEventListener('click', function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });
    </script>
</body>

</html>