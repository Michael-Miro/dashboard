<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>驻 ' - 拽 3</title>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #1e3a5f;
            --secondary: #2d5a87;
            --success: #28a745;
            --danger: #dc3545;
            --bg: #f5f7fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }

        body { background-color: var(--bg); min-height: 100vh; color: #333; line-height: 1.5; }

        /* Header & Tabs */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tabs {
            display: flex; gap: 8px; padding: 10px 20px; background: white;
            border-bottom: 1px solid #e0e0e0; position: sticky; top: 0; z-index: 100;
        }

        .tab-button {
            flex: 1; padding: 10px; border: none; background: #e8eef5;
            color: var(--primary); font-weight: 600; border-radius: 8px; cursor: pointer;
        }

        .tab-button.active { background: var(--primary); color: white; }

        .container { padding: 20px; max-width: 1200px; margin: 0 auto; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Stats Bar */
        .stats-bar {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px; margin-bottom: 20px;
        }

        .stat-card {
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center;
        }

        .stat-card h3 { font-size: 12px; color: #666; margin-bottom: 5px; }
        .stat-card .number { font-size: 24px; font-weight: 800; color: var(--primary); }

        /* Actions */
        .actions-bar {
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;
        }

        .search-box {
            flex: 1; min-width: 200px; padding: 12px;
            border: 1px solid #ddd; border-radius: 10px; font-size: 16px;
        }

        .add-button {
            padding: 12px 20px; background: var(--success); color: white;
            border: none; border-radius: 10px; font-weight: 600; cursor: pointer;
        }

        /* Desktop Table */
        .data-table {
            width: 100%; border-collapse: separate; border-spacing: 0 8px;
        }

        .data-table th { padding: 12px; text-align: right; color: #666; font-weight: 500; }

        .clickable-row td {
            background: white; padding: 15px;
        }

        .clickable-row td:first-child { border-radius: 0 12px 12px 0; }
        .clickable-row td:last-child { border-radius: 12px 0 0 12px; }

        /* --- SMOOTH ACCORDION --- */
        .detail-row { display: none; }
        .detail-row.active { display: table-row; }

        .detail-container {
            overflow: hidden; max-height: 0;
            transition: max-height 0.3s ease-out;
            background: #f8fafd; border-radius: 12px;
            margin: 0 10px 10px 10px;
        }

        .detail-row.active .detail-container { max-height: 500px; padding: 20px; border: 1px solid #e1e8f0; }

        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .detail-item label { display: block; font-size: 11px; color: #888; }
        .detail-item span { font-weight: 600; font-size: 14px; }

        /* Status Badges */
        .status-badge {
            padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 600;
        }
        .status-available, .status-on-base { background: #e6f4ea; color: #1e7e34; }
        .status-in-use, .status-refresher { background: #fff9e6; color: #b08900; }
        .status-maintenance, .status-sick { background: #fce8e8; color: #d93025; }
        .status-working { background: #e8f0fe; color: #1967d2; }

        .btn-edit { background: #f0f4f8; border: none; padding: 8px 12px; border-radius: 6px; color: var(--primary); cursor: pointer; margin-left: 5px; }
        .btn-delete { background: #fff0f0; border: none; padding: 8px 12px; border-radius: 6px; color: var(--danger); cursor: pointer; }

        /* --- MOBILE OPTIMIZATION --- */
        @media (max-width: 600px) {
            .data-table thead { display: none; }
            .data-table, .data-table tbody, .data-table tr, .data-table td { display: block; width: 100%; }
            
            .clickable-row {
                background: white; border-radius: 12px; margin-bottom: 10px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 10px;
                display: flex !important; justify-content: space-between; align-items: center;
            }

            .clickable-row td { border: none !important; padding: 5px !important; background: none !important; }
            
            /* Hide non-essential columns on mobile preview to keep it clean */
            .clickable-row td:nth-child(2), 
            .clickable-row td:nth-child(4) { display: none; }

            .detail-row.active { display: block; margin-top: -15px; margin-bottom: 15px; }
            .detail-container { margin: 0; }
        }

        /* Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: flex-end;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; width: 100%; max-width: 500px; padding: 25px;
            border-radius: 20px 20px 0 0; animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 14px; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; }
        .submit-button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; }
    </style>
</head>

<body>

<header class="header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2 style="font-size: 18px;">拽 3 - 砖</h2>
        <button onclick="syncAllData()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 8px;"></button>
    </div>
</header>

<nav class="tabs">
    <button class="tab-button active" data-tab="cars">专</button>
    <button class="tab-button" data-tab="people"> </button>
</nav>

<div class="container">
    <div id="cars" class="tab-content active">
        <div class="stats-bar">
            <div class="stat-card"><h3>专</h3><div class="number" id="total-cars">0</div></div>
            <div class="stat-card"><h3></h3><div class="number" id="available-cars">0</div></div>
            <div class="stat-card"><h3>驻</h3><div class="number" id="maint-cars">0</div></div>
        </div>
        <div class="actions-bar">
            <input type="text" class="search-box" id="search-cars" placeholder="驻砖 专 (爪')..." oninput="renderCars()">
            <button class="add-button" onclick="openModal('car')">+</button>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>专</th><th>住</th><th>住住</th><th></th><th></th>
                </tr>
            </thead>
            <tbody id="cars-body"></tbody>
        </table>
    </div>

    <div id="people" class="tab-content">
        <div class="stats-bar">
            <div class="stat-card"><h3>住"</h3><div class="number" id="total-people">0</div></div>
            <div class="stat-card"><h3>住住</h3><div class="number" id="ppl-base">0</div></div>
            <div class="stat-card"><h3>注</h3><div class="number" id="ppl-work">0</div></div>
        </div>
        <div class="actions-bar">
            <input type="text" class="search-box" id="search-ppl" placeholder="驻砖 砖/...." oninput="renderPeople()">
            <button class="add-button" onclick="openModal('person')">+</button>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>砖</th><th>.</th><th>住住</th><th>驻</th><th></th>
                </tr>
            </thead>
            <tbody id="people-body"></tbody>
        </table>
    </div>
</div>

<div class="modal" id="car-modal">
    <div class="modal-content">
        <h3 style="margin-bottom:20px">驻专 专</h3>
        <form id="car-form" onsubmit="saveCar(event)">
            <input type="hidden" id="car-id">
            <div class="form-group"><label>住驻专 爪'</label><input type="text" id="car-number" required></div>
            <div class="form-group"><label>住住</label>
                <select id="car-status">
                    <option value="available"></option>
                    <option value="in-use">砖砖</option>
                    <option value="maintenance">转拽</option>
                </select>
            </div>
            <div class="form-group"><label> 砖</label><select id="car-driver"></select></div>
            <div class="form-group"><label>驻 </label><input type="date" id="car-next"></div>
            <button type="submit" class="submit-button">砖专 转</button>
            <button type="button" onclick="closeModal('car')" style="width:100%; background:none; border:none; margin-top:15px; color:#666"></button>
        </form>
    </div>
</div>

<div class="modal" id="person-modal">
    <div class="modal-content">
        <h3 style="margin-bottom:20px">驻专 </h3>
        <form id="person-form" onsubmit="savePerson(event)">
            <input type="hidden" id="person-id">
            <div class="form-group"><label>砖 </label><input type="text" id="person-name" required></div>
            <div class="form-group"><label>.</label><input type="text" id="person-id-num" required></div>
            <div class="form-group"><label>住住</label>
                <select id="person-status" onchange="toggleWorkFields()">
                    <option value="on-base">住住</option>
                    <option value="working">注 (抓)</option>
                    <option value="sick">/</option>
                </select>
            </div>
            <div id="work-info" style="display:none">
                <div class="form-group"><label>/住住</label><input type="text" id="person-unit"></div>
            </div>
            <button type="submit" class="submit-button">砖专 转</button>
            <button type="button" onclick="closeModal('person')" style="width:100%; background:none; border:none; margin-top:15px; color:#666"></button>
        </form>
    </div>
</div>

<script>
    let cars = JSON.parse(localStorage.getItem('fleet_cars')) || [];
    let people = JSON.parse(localStorage.getItem('fleet_people')) || [
        { id: '1', name: '砖专 砖专', idNumber: '1234567', phone: '050-0000000', status: 'on-base' }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        setupTabs();
        renderCars();
        renderPeople();
        updateStats();
    });

    function setupTabs() {
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-button, .tab-content').forEach(el => el.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });
    }

    function toggleRow(id) {
        const row = document.getElementById(id);
        const wasActive = row.classList.contains('active');
        document.querySelectorAll('.detail-row').forEach(r => r.classList.remove('active'));
        if (!wasActive) row.classList.add('active');
    }

    function renderCars() {
        const term = document.getElementById('search-cars').value.toLowerCase();
        const tbody = document.getElementById('cars-body');
        tbody.innerHTML = '';
        
        cars.filter(c => c.number.includes(term)).forEach(car => {
            const driver = people.find(p => p.id === car.driverId);
            const tr = document.createElement('tr');
            tr.className = 'clickable-row';
            tr.onclick = (e) => { if(!e.target.closest('button')) toggleRow(`car-${car.id}`); };
            tr.innerHTML = `
                <td style="font-weight:700">${car.number}</td>
                <td>${car.type || '驻专'}</td>
                <td><span class="status-badge status-${car.status}">${getStatusHeb(car.status)}</span></td>
                <td>${driver ? driver.name : '-'}</td>
                <td><button class="btn-edit" onclick="editCar('${car.id}')">锔</button></td>
            `;

            const dtr = document.createElement('tr');
            dtr.id = `car-${car.id}`;
            dtr.className = 'detail-row';
            dtr.innerHTML = `
                <td colspan="5">
                    <div class="detail-container">
                        <div class="detail-grid">
                            <div class="detail-item"><label></label><span>${driver ? driver.name : ''}</span></div>
                            <div class="detail-item"><label>驻</label><span>${car.next || ' '}</span></div>
                            <div class="detail-item"><label>住住</label><span>${getStatusHeb(car.status)}</span></div>
                            <div class="detail-item"><button class="btn-delete" onclick="deleteCar('${car.id}')">拽 专</button></div>
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(tr); tbody.appendChild(dtr);
        });
    }

    function renderPeople() {
        const term = document.getElementById('search-ppl').value.toLowerCase();
        const tbody = document.getElementById('people-body');
        tbody.innerHTML = '';
        
        people.filter(p => p.name.includes(term) || p.idNumber.includes(term)).forEach(p => {
            const tr = document.createElement('tr');
            tr.className = 'clickable-row';
            tr.onclick = (e) => { if(!e.target.closest('button')) toggleRow(`ppl-${p.id}`); };
            tr.innerHTML = `
                <td style="font-weight:700">${p.name}</td>
                <td style="color:#666; font-size:13px">${p.idNumber}</td>
                <td><span class="status-badge status-${p.status}">${getStatusHeb(p.status)}</span></td>
                <td>${p.phone || '-'}</td>
                <td><button class="btn-edit" onclick="editPerson('${p.id}')">锔</button></td>
            `;

            const dtr = document.createElement('tr');
            dtr.id = `ppl-${p.id}`;
            dtr.className = 'detail-row';
            dtr.innerHTML = `
                <td colspan="5">
                    <div class="detail-container">
                        <div class="detail-grid">
                            <div class="detail-item"><label>.</label><span>${p.idNumber}</span></div>
                            <div class="detail-item"><label>/住住</label><span>${p.unit || '住住'}</span></div>
                            <div class="detail-item"><label>驻</label><span>${p.phone || ''}</span></div>
                            <div class="detail-item"><button class="btn-delete" onclick="deletePerson('${p.id}')">住专 专砖</button></div>
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(tr); tbody.appendChild(dtr);
        });
    }

    function getStatusHeb(s) {
        const m = { 'available':'', 'in-use':'砖砖', 'maintenance':'驻', 'on-base':'住住', 'working':'注转 抓', 'sick':'/' };
        return m[s] || s;
    }

    function openModal(type) {
        if(type === 'car') { 
            document.getElementById('car-form').reset(); 
            document.getElementById('car-id').value = ''; 
            const s = document.getElementById('car-driver');
            s.innerHTML = '<option value=""> </option>';
            people.forEach(p => s.innerHTML += `<option value="${p.id}">${p.name}</option>`);
            document.getElementById('car-modal').classList.add('active'); 
        } else {
            document.getElementById('person-form').reset();
            document.getElementById('person-id').value = '';
            document.getElementById('person-modal').classList.add('active');
        }
    }

    function closeModal(t) { document.getElementById(`${t}-modal`).classList.remove('active'); }

    function saveCar(e) {
        e.preventDefault();
        const id = document.getElementById('car-id').value || Date.now().toString();
        const obj = {
            id,
            number: document.getElementById('car-number').value,
            status: document.getElementById('car-status').value,
            driverId: document.getElementById('car-driver').value,
            next: document.getElementById('car-next').value
        };
        const idx = cars.findIndex(c => c.id === id);
        if(idx > -1) cars[idx] = obj; else cars.push(obj);
        localStorage.setItem('fleet_cars', JSON.stringify(cars));
        renderCars(); updateStats(); closeModal('car');
    }

    function editCar(id) {
        const c = cars.find(x => x.id === id);
        openModal('car');
        document.getElementById('car-id').value = c.id;
        document.getElementById('car-number').value = c.number;
        document.getElementById('car-status').value = c.status;
        document.getElementById('car-driver').value = c.driverId;
        document.getElementById('car-next').value = c.next;
    }

    function savePerson(e) {
        e.preventDefault();
        const id = document.getElementById('person-id').value || Date.now().toString();
        const obj = {
            id,
            name: document.getElementById('person-name').value,
            idNumber: document.getElementById('person-id-num').value,
            status: document.getElementById('person-status').value,
            unit: document.getElementById('person-unit').value
        };
        const idx = people.findIndex(p => p.id === id);
        if(idx > -1) people[idx] = obj; else people.push(obj);
        localStorage.setItem('fleet_people', JSON.stringify(people));
        renderPeople(); updateStats(); closeModal('person');
    }

    function editPerson(id) {
        const p = people.find(x => x.id === id);
        openModal('person');
        document.getElementById('person-id').value = p.id;
        document.getElementById('person-name').value = p.name;
        document.getElementById('person-id-num').value = p.idNumber;
        document.getElementById('person-status').value = p.status;
        document.getElementById('person-unit').value = p.unit || '';
        toggleWorkFields();
    }

    function deleteCar(id) { cars = cars.filter(c => c.id !== id); localStorage.setItem('fleet_cars', JSON.stringify(cars)); renderCars(); updateStats(); }
    function deletePerson(id) { people = people.filter(p => p.id !== id); localStorage.setItem('fleet_people', JSON.stringify(people)); renderPeople(); updateStats(); }

    function toggleWorkFields() {
        const s = document.getElementById('person-status').value;
        document.getElementById('work-info').style.display = s === 'working' ? 'block' : 'none';
    }

    function updateStats() {
        document.getElementById('total-cars').innerText = cars.length;
        document.getElementById('available-cars').innerText = cars.filter(c => c.status === 'available').length;
        document.getElementById('maint-cars').innerText = cars.filter(c => c.status === 'maintenance').length;
        document.getElementById('total-people').innerText = people.length;
        document.getElementById('ppl-base').innerText = people.filter(p => p.status === 'on-base').length;
        document.getElementById('ppl-work').innerText = people.filter(p => p.status === 'working').length;
    }

    function syncAllData() { alert("转 砖专 拽转 住专."); }
</script>
</body>
</html>